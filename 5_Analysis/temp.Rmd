---
title: "Untitled"
author: "yuki"
date: "2023-05-17"
output: html_document
---

```{r setup, include=FALSE}
SPE_half_1 <- shl[[1]][[1]] %>%
      dplyr::group_by(Subject,Session,Identity) %>%
      dplyr::summarise(
        hit = length(ACC[Matching == "Matching" & ACC == 1]),
        fa = length(ACC[Matching == "Nonmatching" & ACC == 0]),
        miss = length(ACC[Matching == "Matching" & ACC == 0]),
        cr = length(ACC[Matching == "Nonmatching" & ACC == 1]),
        Dprime = qnorm(
          ifelse(hit / (hit + miss) < 1,
                 hit / (hit + miss),
                 1 - 1 / (2 * (hit + miss))
          )
        ) - qnorm(
          ifelse(fa / (fa + cr) > 0,
                 fa / (fa + cr),
                 1 / (2 * (fa + cr))
          )
        )) %>%
      dplyr::ungroup() %>%
      select(-"hit",-"fa",-"miss",-"cr") %>%
      tidyr::pivot_wider(names_from = Identity,
                         values_from = Dprime) %>%
      dplyr::mutate(dprime_SPE_1 = Self - Partner) %>%
      dplyr::select(Subject, Session, dprime_SPE_1) 

SPE_half_2 <- shl[[1]][[2]] %>%
      dplyr::group_by(Subject,Session,Identity) %>%
      dplyr::summarise(
        hit = length(ACC[Matching == "Matching" & ACC == 1]),
        fa = length(ACC[Matching == "Nonmatching" & ACC == 0]),
        miss = length(ACC[Matching == "Matching" & ACC == 0]),
        cr = length(ACC[Matching == "Nonmatching" & ACC == 1]),
        Dprime = qnorm(
          ifelse(hit / (hit + miss) < 1,
                 hit / (hit + miss),
                 1 - 1 / (2 * (hit + miss))
          )
        ) - qnorm(
          ifelse(fa / (fa + cr) > 0,
                 fa / (fa + cr),
                 1 / (2 * (fa + cr))
          )
        )) %>%
      dplyr::ungroup() %>%
      select(-"hit",-"fa",-"miss",-"cr") %>%
      tidyr::pivot_wider(names_from = Identity,
                         values_from = Dprime) %>%
      dplyr::mutate(dprime_SPE_2 = Self - Partner) %>%
      dplyr::select(Subject, Session, dprime_SPE_2) 

    df.cor <- SPE_half_1 %>%
      dplyr::left_join(SPE_half_2, by = c("Subject", "Session")) %>%
      dplyr::filter(!is.na(dprime_SPE_1) & !is.na(dprime_SPE_2)) %>%
      dplyr::filter(is.finite(dprime_SPE_1) & is.finite(dprime_SPE_2))

cor(df.cor[,3], df.cor[,4], method = "pearson")
```

```{r}
temp <- df[[2]] %>%
  filter(Subject == 7) %>%
    filter(Matching == Matching) %>%
ggplot2::ggplot(aes(x = Identity, y = RT_sec)) + 
  ggdist::stat_dots() +
  facet_wrap(~ Session)
temp

```




