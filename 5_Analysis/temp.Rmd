---
title: "Untitled"
author: "yuki"
date: "2023-06-02"
output: html_document
---
```{r Create df_test}
df_test <- df[[1]] 
```

# First-Second
```{r First-Second SHR}
shl_test[[1]] <- yukiSH::sh_tool(df.split = df_test, method = "fs", sub = "Subject", var1 = "Matching", var2 = "Identity", var3 = "Session")
```
# Odd-Even
```{r Odd-Even SHR}
shl_test[[2]] <- yukiSH::sh_tool(df.split = df_test, method = "od", sub = "Subject", var1 = "Matching", var2 = "Identity", var3 = "Session")
```
# Permuted
```{r Permuted SHR}
shl_test[[3]] <- yukiSH::sh_tool(df.split = df_test, method = "permuted", sub = "Subject", var1 = "Matching", var2 = "Identity", var3 = "Session")
```
# Monte Carlo
```{r Monte Carlo SHR}
shl_test[[4]] <- yukiSH::sh_tool(df.split = df_test, method = "mc", sub = "Subject", var1 = "Matching", var2 = "Identity", var3 = "Session",
                                 iteration = 10, nc = 16)
```

# Revert ACC from 01 -> lower;upper
```{r half_1: 01 -> lower;upper}
SPE_half_1 <- shl_test[[1]][[1]] %>%
  # RWiener::wdm 只识别lower upper
  dplyr::mutate(ACC = case_when(ACC == 0 ~ "lower",
                                ACC == 1 ~ "upper")) %>%
  # RWiener::wdm 只接受一个分组变量
  split(.$Subject)
```

```{r half_2: 01 -> lower;upper}
SPE_half_2 <- shl_test[[1]][[2]] %>%
  # RWiener::wdm 只识别lower upper
  dplyr::mutate(ACC = case_when(ACC == 0 ~ "lower",
                                ACC == 1 ~ "upper")) %>%
  # RWiener::wdm 只接受一个分组变量
  split(.$Subject)
```

# Unite Subject, Matching, Identity, Session into group
```{r half_1: unite group variables}
SPE_half_1[[1]] <- SPE_half_1[[1]] %>%
  tidyr::unite(group, Subject, Matching, Identity, Session, sep = "_") %>%
  dplyr::mutate(group = factor(group))
```

```{r half_2: unite group variables}
SPE_half_2[[1]] <- SPE_half_2[[1]] %>%
  tidyr::unite(group, Subject, Matching, Identity, Session, sep = "_") %>%
  dplyr::mutate(group = factor(group))
```

# Run RWiener::wdm for each Subject
```{r half_1: run wdm}
Start_Time <- Sys.time()
temp2 <- RWiener::wdm(SPE_half_1[[1]], xvar = "group", yvar = c("RT_sec", "ACC"))
End_Time <- Sys.time()
```

```{r half_1: run wdm}
Start_Time <- Sys.time()
temp2 <- RWiener::wdm(SPE_half_2[[1]], xvar = "group", yvar = c("RT_sec", "ACC"))
End_Time <- Sys.time()
```

# Clean the Result of RWiener::wdm
```{r half_1: result}
options(scipen = 999)
result1 <- data.frame(temp1$coefficients) %>%
  dplyr::mutate(group = rownames(.)) %>%
  tidyr::separate(group, into = c("Subject", "Matching", "Identity", "Session"), sep = "_") %>%
  tidyr::separate(Session, into = c("Session", "Indice"), sep = ":") %>%
  tidyr::pivot_wider(names_from = Indice,
                     values_from = temp1.coefficients) %>%
  dplyr::mutate(a = alpha, t = tau, z = beta, v = delta,
                Subject = as.numeric(Subject),
                Matching = factor(Matching,
                                  levels = c("Matching", "Nonmatching")),
                Identity = factor(Identity,
                                  levels = c("Self", "Friend", "Stranger")),
                Session = as.character(Session)
                ) %>%
  dplyr::arrange(Subject, Matching, Identity, Session) %>%
  dplyr::select(Subject, Matching, Identity, Session, a, t, z, v)
write.csv(x = result1, file = "./df_test6018.csv")
```

```{r half_2: result}
result2 <- data.frame(temp2$coefficients) %>%
  dplyr::mutate(group = rownames(.)) %>%
  tidyr::separate(group, into = c("Subject", "Matching", "Identity", "Session"), sep = "_") %>%
  tidyr::separate(Session, into = c("Session", "Indice"), sep = ":") %>%
  tidyr::pivot_wider(names_from = Indice,
                     values_from = temp2.coefficients) %>%
  dplyr::mutate(a = alpha, t = tau, z = beta, v = delta,
                Subject = as.numeric(Subject),
                Matching = factor(Matching,
                                  levels = c("Matching", "Nonmatching")),
                Identity = factor(Identity,
                                  levels = c("Self", "Friend", "Stranger")),
                Session = as.character(Session)
                ) %>%
  dplyr::arrange(Subject, Matching, Identity, Session) %>%
  dplyr::select(Subject, Matching, Identity, Session, a, t, z, v)
```

# Calculate Correlations
```{r}
cor(result1$z, result2$z)
cor(result1$v, result2$v)
```


