---
title: "test"
author: "yuki"
date: "2023-06-17"
output: html_document
---
```{r}
Target <- c("Self", "Friend", "Stranger")
```

################################################################################
test shr
################################################################################

```{r}
Half_1 <- shl[[4]][[1]][[1]] %>%
  dplyr::filter(., Matching == "Matching", ACC == "1") %>%
  dplyr::group_by(Subject, Session, Identity) %>%
  dplyr::summarise(mean_rt = mean(RT_ms)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = Identity,
                     values_from = mean_rt)

Half_2 <- shl[[4]][[1]][[2]] %>%
  dplyr::filter(., Matching == "Matching", ACC == "1") %>%
  dplyr::group_by(Subject, Session, Identity) %>%
  dplyr::summarise(mean_rt = mean(RT_ms)) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = Identity,
                     values_from = mean_rt)

```

```{r}
SPE_Half_1 <-list()
SPE_Half_2 <-list()
r <- list()
for (i in 2 : length(Target)) {
  SPE_Half_1[[i-1]] <- Half_1 %>%
    dplyr::mutate(SPE_1 = Self - !!sym(Target[i])) %>%
    dplyr::select(Subject, Session, SPE_1)
  
  SPE_Half_2[[i-1]] <- Half_2 %>%
    dplyr::mutate(SPE_2 = Self - !!sym(Target[i])) %>%
    dplyr::select(Subject, Session, SPE_2)
  
  df.cor <- SPE_Half_1[[i-1]] %>%
    dplyr::left_join(SPE_Half_2[[i-1]], by = c("Subject", "Session")) %>%
    dplyr::filter(!is.na(SPE_1) & !is.na(SPE_2)) %>%
    dplyr::filter(is.finite(SPE_1) & is.finite(SPE_2))
  
  r[[i-1]] <-  cor(df.cor[,3], df.cor[,4], method = "pearson")
  names(r)[[i-1]] <- Target[i]
}
```

```{r}
  result <- rbind(r) %>%
    as.data.frame() %>%
    `rownames<-`(NULL)
```

```{r}
result <- shr_rt(list = shl[[2]], Target = c("Self", "Friend", "Stranger"))
```

################################################################################
test mcshr
################################################################################

```{r}
  # 设置并行计算
  registerDoParallel(cores = 16)

  # 初始化一个空的数据框
  df_result <- data.frame()

  # 获取列表的长度
  list_length <- length(shl[[4]])

  # 定义每次迭代处理的元素个数
  subset_size <- 16

  # 循环遍历选取nc个元素的列表
  for (i in 1:ceiling(list_length / subset_size)) {
    # 计算当前迭代需要处理的元素范围
    start_index <- (subset_size * (i - 1)) + 1
    end_index <- min(subset_size * i, list_length)

    # 从列表中选取当前迭代需要处理的元素
    list_subset <- shl[[4]][start_index:end_index]

    # 使用foreach循环并行执行迭代
    result <- foreach(j = 1:length(list_subset), .combine = rbind, .packages = c("dplyr", "tidyr")) %dopar% {

      # 调用函数并得到数据框
      shr_rt(list = list_subset[[j]], Target = Target)

    }

    # 合并每次得到的结果
    df_result <- bind_rows(df_result, result)
  }

  df_result$Paper_ID <- "P0S1"
  
  # 停止并行计算
  stopImplicitCluster()

```

```{r}
df_rt <- loop_shr_rt(list = shl[[4]], Target = c("Self", "Friend", "Stranger"), Paper_ID = "P0S1",Indice = "rt", nc = 16)
```

```{r}
output <- df_rt %>%
  tidyr::pivot_longer(cols = Target[2:length(Target)], names_to = "Target", values_to = "r") %>%
  dplyr::mutate(r = as.numeric(r)) %>%
  dplyr::group_by(Target) %>%
  dplyr::mutate(Mean = mean(r),
                LLCI = quantile(r, 0.025),
                ULCI = quantile(r, 0.975),
                ) %>%
  dplyr::select(Paper_ID, Indice, Target, Mean, LLCI, ULCI) %>%
  dplyr::distinct()
```

```{r}
mcshr(list = shl[[4]], Target = c("Self", "Friend", "Stranger"), Paper_ID = "P0S1", Indice = "rt", nc = 16)
```
```{r}
output <- df_rt %>%
  dplyr::filter(Iteration == 1 | Iteration == 2 | Iteration == 3) %>%
  dplyr::mutate(Method = case_when(Iteration == 1 ~ "First-Second",
                                   Iteration == 2 ~ "Odd-Even",
                                   Iteration == 3 ~ "Permuted")) %>%
  tidyr::pivot_longer(cols = Target[2:length(Target)], names_to = "Target", values_to = "r") %>%
  dplyr::select(Paper_ID, Indice, Target, r, Method)
```

```{r}
nmshr(list = shl[1:3], Target = c("Self", "Friend", "Stranger"), Paper_ID = "P0S1", Indice = "rt", nc = 3)
```

```{r}
    # 不关心Nonmatching组的情况，提前筛选掉，提高运行速度
df_test_ez <- df[[1]] %>%    
dplyr::filter(Matching == "Matching",
              Subject == 6001 | Subject == 6002 |Subject == 6003) %>%
    hausekeep::fit_ezddm(data = ., rts = "RT_sec", responses = "ACC", id = "Subject", group = c("Session", "Matching", "Identity")) %>%
    dplyr::mutate(z = a / 2,
                  t = t0_Ter) %>%
    dplyr::select(Subject, Session, Matching, Identity, a, t, v, z) 

df_test_ez <- df_test_ez %>%
  dplyr::select(Subject, Session, Matching, Identity, v) %>%
  tidyr::pivot_wider(names_from = Identity,
                     values_from = v)

dif_ez <- df_test_ez %>%
  dplyr::mutate(SPE = Self - Stranger)
```

```{r}
df_test_rw <- df[[1]] %>%  
    # 不关心Nonmatching组的情况，提前筛选掉，提高运行速度
  dplyr::filter(Matching == "Matching",
                Subject == 6001 | Subject == 6002 |Subject == 6003) %>%
  # RWiener::wdm 只识别lower upper
  dplyr::mutate(ACC = case_when(ACC == 0 ~ "lower",
                                ACC == 1 ~ "upper")) %>%
  # RWiener::wdm 一次接受一个被试
  split(.$Subject) %>%
  ###############################CORE CODES###################################
  base::lapply(., rwddm) %>%
  ###############################CORE CODES###################################
  # 将分割的结果重新组合
  base::do.call(rbind, .)

df_test_rw <- df_test_rw %>%
  dplyr::select(Subject, Session, Matching, Identity, v) %>%
  tidyr::pivot_wider(names_from = Identity,
                     values_from = v)

dif_rw <- df_test_rw %>%
  dplyr::mutate(SPE = Self - Stranger)
```

```{r}
cor(dif_ez$SPE, dif_rw$SPE)
```

