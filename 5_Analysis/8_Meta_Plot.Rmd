---
title: "8_Meta_Plot"
author: "yuki"
date: "2023-09-07"
output: html_document
---
```{r}
out <- list()
```

```{r}
out[[1]] <- res_meta[[1]][[1]] %>%
  base::summary() %>% # 得到yi, vi, sei, zi, ci.lb, ci.ub这些变量
  dplyr::left_join(desc[[1]], by = "Paper_ID") %>%
  dplyr::arrange(yi) %>%
  dplyr::mutate(
    ############################################################################
    Unique_ID = paste0(Author," (",Year,")",", S",Study),
    Order = row_number(),
    ############################################################################
    pval = ifelse(
      pval < 0.001, "<.001", 
      ifelse(pval < 0.05, sprintf("%.3f", pval), sprintf("%.2f", pval))),
    yi_r = round(abs(yi), 2),
    ci.lb = round(ci.lb*-1, 2),
    ci.ub = round(ci.ub*-1, 2),
    zi = round(abs(zi), 2),
    ############################################################################
    LLCI = case_when(
      ci.lb < ci.ub ~ ci.lb,
      ci.lb > ci.ub ~ ci.ub,
    ),
    ULCI = case_when(
      ci.ub > ci.lb ~ ci.ub,
      ci.ub < ci.lb ~ ci.lb,
    ),
    CI = paste(yi_r, "[", LLCI, ", ", ULCI, "]", sep = ""),
    ############################################################################
  ) %>%
  dplyr::select(
    Paper_ID, Author, Year, Study,
    Unique_ID, Order,
    yi_r, vi, sei, zi, 
    LLCI, ULCI, CI, pval
  ) 

names(out)[1] <- "Self - Close"

```

```{r}
ggplot2::ggplot(out[[1]], aes(x = yi_r , y = reorder(Unique_ID, Order))) +
  ggplot2::geom_linerange(aes(xmin = LLCI, xmax = ULCI), linewidth = 1.5) +
  ggplot2::geom_point(shape=15, size = 5) +
  #ggplot2::geom_linerange(aes(xmin = fix_ci.lb, xmax = fix_ci.ub, y = 1.5), linewidth = 3, color = "grey") + # Fixed Effect CI
  #ggplot2::geom_point(aes(x = fix_yi, y = 1.5), shape=15, size = 7, color = "grey") + # Fixed Effect Point
  ggplot2::scale_x_continuous(
    limits = c(-3.5, 2.5), 
    breaks = seq(-0.5,2, by = 0.5),
    sec.axis = sec_axis(~., breaks = c(-2.8, -1.2, 2.3),
                        labels = c("Author(s), Year and Study", "SMD (95%-CI)", "p-value")),
  ) +
  ggplot2::geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 3, alpha = 0.5) +
  ggplot2::geom_text(aes(x = -3.5, y = reorder(Unique_ID, Order), label = reorder(Unique_ID, Order)), size = 7, hjust = 0, family='serif',) + # Author_Year_Study
  ggplot2::geom_text(aes(x = -1.6, y = reorder(Unique_ID, Order), label = CI),hjust = 0, size = 7, family='serif',) + # CI
  ggplot2::geom_text(aes(x = 2.2, y = reorder(Unique_ID, Order), label = pval), size = 7, hjust = 0, family='serif',) + # Right: P-value
  #ggplot2::annotate("text", x = -3.5, y = 1 ,label = "Q (161) = 1426.33, p <.0001, I2 = 90.90%", size = 16, family='serif', color = "black") +
  #ggplot2::annotate("text", x = -3, y = 2 ,label = "Random Effect = -0.88, SE = 0.05, p <.01, 95% CI [-.97, -.79]", size = 16, family='serif', color = "black") +
  ggplot2::labs(x = "Hedges' g") +
  ggplot2::ggtitle("Meta-Analysis for RT (Self - Close)") +
  papaja::theme_apa() +
  ggplot2::theme(legend.position = "none",
                 axis.text.x.top = element_text(size = 20, family='serif'),
                 axis.text.x.bottom = element_text(size = 15, family='serif'),
                 axis.title.x = element_text(size = 20, hjust = 0.75),
                 plot.title = element_text(size = 20, family = 'serif'),
                 legend.title = element_blank(),
                 axis.line.y = element_blank(),
                 axis.ticks.x.top = element_line(color = "transparent"), #消除坐标轴上刻度凸起
                 axis.ticks.y= element_blank(),
                 axis.text.y= element_blank(),
                 axis.title.y= element_blank(),
                 ) 

ggsave(filename = "./FIGURE/Forrest_Close.png", width = 16, height = 9, limitsize = FALSE)
```

